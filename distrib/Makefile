TOP_SRCDIR = .
COMPONENT = DISTRIB  
include $(TOP_SRCDIR)/Makefile.common

DISTRIB_COREUTILS =    \
	coreutils/cat        \
	coreutils/chgrp      \
	coreutils/chmod      \
	coreutils/chown      \
	coreutils/cp         \
	coreutils/date       \
	coreutils/dd         \
	coreutils/df         \
	coreutils/dmesg      \
	coreutils/echo       \
	coreutils/false      \
	coreutils/halt       \
	coreutils/hostname   \
	coreutils/kill       \
	coreutils/ln         \
	coreutils/login      \
	coreutils/ls         \
	coreutils/mkdir      \
	coreutils/mknod      \
	coreutils/more       \
	coreutils/mount      \
	coreutils/mv         \
	coreutils/ps         \
	coreutils/pwd        \
	coreutils/rm         \
	coreutils/rmdir      \
	coreutils/sed        \
	coreutils/sh         \
	coreutils/stty       \
	coreutils/su         \
	coreutils/sync       \
	coreutils/true       \
	coreutils/umount     \
	coreutils/uname      \
	coreutils/init       \

DISTRIB_ULIBC = ulibc/ulibc.o

DISTRIB_ULIBC_OBJECTS =       \
	ulibc/ctype/isalnum.o     \
	ulibc/ctype/isalpha.o     \
	ulibc/ctype/iscntrl.o     \
	ulibc/ctype/isdigit.o     \
	ulibc/ctype/isgraph.o     \
	ulibc/ctype/islower.o     \
	ulibc/ctype/isprint.o     \
	ulibc/ctype/ispunct.o     \
	ulibc/ctype/isspace.o     \
	ulibc/ctype/isupper.o     \
	ulibc/ctype/isxdigit.o    \
	ulibc/ctype/tolower.o     \
	ulibc/ctype/toupper.o     \
	ulibc/errno/errno.o       \
	ulibc/locale/localeconv.o \
	ulibc/locale/setlocale.o  \
	ulibc/math/acos.o         \
	ulibc/math/asin.o         \
	ulibc/math/atan2.o        \
	ulibc/math/atan.o         \
	ulibc/math/ceil.o         \
	ulibc/math/cos.o          \
	ulibc/math/cosh.o         \
	ulibc/math/exp.o          \
	ulibc/math/fabs.o         \
	ulibc/math/floor.o        \
	ulibc/math/fmod.o         \
	ulibc/math/frexp.o        \
	ulibc/math/ldexp.o        \
	ulibc/math/log10.o        \
	ulibc/math/log.o          \
	ulibc/math/modf.o         \
	ulibc/math/pow.o          \
	ulibc/math/sin.o          \
	ulibc/math/sinh.o         \
	ulibc/math/sqrt.o         \
	ulibc/math/tan.o          \
	ulibc/math/tanh.o         \
	ulibc/setjmp/setjmp.o     \
	ulibc/setjmp/longjmp.o    \
	ulibc/assert/assert.o     \
	ulibc/signal/signal.o     \
	ulibc/signal/raise.o      \
	ulibc/stdio/stdio.o       \
	ulibc/stdio/clearerr.o    \
	ulibc/stdio/fclose.o      \
	ulibc/stdio/feof.o        \
	ulibc/stdio/ferror.o      \
	ulibc/stdio/fflush.o      \
	ulibc/stdio/fgetc.o       \
	ulibc/stdio/fgetpos.o     \
	ulibc/stdio/fgets.o       \
	ulibc/stdio/fopen.o       \
	ulibc/stdio/fprintf.o     \
	ulibc/stdio/fputc.o       \
	ulibc/stdio/fputs.o       \
	ulibc/stdio/fread.o       \
	ulibc/stdio/freopen.o     \
	ulibc/stdio/fscanf.o      \
	ulibc/stdio/fseek.o       \
	ulibc/stdio/fsetpos.o     \
	ulibc/stdio/fwrite.o      \
	ulibc/stdio/getc.o        \
	ulibc/stdio/getchar.o     \
	ulibc/stdio/gets.o        \
	ulibc/stdio/int.o         \
	ulibc/stdio/perror.o      \
	ulibc/stdio/printf.o      \
	ulibc/stdio/putc.o        \
	ulibc/stdio/putchar.o     \
	ulibc/stdio/puts.o        \
	ulibc/stdio/remove.o      \
	ulibc/stdio/rename.o      \
	ulibc/stdio/rewind.o      \
	ulibc/stdio/scanf.o       \
	ulibc/stdio/setbuf.o      \
	ulibc/stdio/setvbuf.o     \
	ulibc/stdio/sprintf.o     \
	ulibc/stdio/sscanf.o      \
	ulibc/stdio/tmpfile.o     \
	ulibc/stdio/tmpnam.o      \
	ulibc/stdio/ungetc.o      \
	ulibc/stdio/vfprintf.o    \
	ulibc/stdio/vprintf.o     \
	ulibc/stdio/vsprintf.o    \
	ulibc/stdlib/abort.o      \
	ulibc/stdlib/abs.o        \
	ulibc/stdlib/atof.o       \
	ulibc/stdlib/atoi.o       \
	ulibc/stdlib/atol.o       \
	ulibc/stdlib/bsearch.o    \
	ulibc/stdlib/calloc.o     \
	ulibc/stdlib/div.o        \
	ulibc/stdlib/exit.o       \
	ulibc/stdlib/free.o       \
	ulibc/stdlib/getenv.o     \
	ulibc/stdlib/labs.o       \
	ulibc/stdlib/ldiv.o       \
	ulibc/stdlib/malloc.o     \
	ulibc/stdlib/mblen.o      \
	ulibc/stdlib/mbstowcs.o   \
	ulibc/stdlib/mbtowc.o     \
	ulibc/stdlib/qsort.o      \
	ulibc/stdlib/rand.o       \
	ulibc/stdlib/realloc.o    \
	ulibc/stdlib/strtod.o     \
	ulibc/stdlib/strtol.o     \
	ulibc/stdlib/strtoul.o    \
	ulibc/stdlib/system.o     \
	ulibc/stdlib/wcstombs.o   \
	ulibc/stdlib/wctomb.o     \
	ulibc/string/memchr.o     \
	ulibc/string/memcmp.o     \
	ulibc/string/memcpy.o     \
	ulibc/string/memmove.o    \
	ulibc/string/memset.o     \
	ulibc/string/strcat.o     \
	ulibc/string/strchr.o     \
	ulibc/string/strcmp.o     \
	ulibc/string/strcoll.o    \
	ulibc/string/strcpy.o     \
	ulibc/string/strcspn.o    \
	ulibc/string/strerror.o   \
	ulibc/string/strlen.o     \
	ulibc/string/strncat.o    \
	ulibc/string/strncmp.o    \
	ulibc/string/strncpy.o    \
	ulibc/string/strpbrk.o    \
	ulibc/string/strrchr.o    \
	ulibc/string/strspn.o     \
	ulibc/string/strstr.o     \
	ulibc/string/strtok.o     \
	ulibc/string/strxfrm.o    \
	ulibc/time/asctime.o      \
	ulibc/time/clock.o        \
	ulibc/time/ctime.o        \
	ulibc/time/difftime.o     \
	ulibc/time/gmtime.o       \
	ulibc/time/localtime.o    \
	ulibc/time/mktime.o       \
	ulibc/time/strftime.o     \
	ulibc/time/time.o         \
	ulibc/usys.o              \
	ulibc/printf.o            \
	ulibc/ulib.o              \
	ulibc/umalloc.o           \

DISTRIB_ULIBC_TESTS = \
	tests/stdlib        \
	tests/string        \
	tests/init          \

.PHONY: all check motd
.PRECIOUS: coreutils/%.o ulibc/%.o tests/%.o

all: distrib.img

check: distrib_check.img

motd:
	@echo "\033[32;1m"
	@echo "[>>] [DISTRIB  ]"
	@echo -n "\033[0m"

distrib.img: motd mkfs.xv6 $(DISTRIB_COREUTILS)
	$(LOG_CMD) ./mkfs.xv6 distrib.img release
	@echo "\033[32;1mCreated distribution disk image "\""$@"\""\033[0m"

distrib_check.img: motd mkfs.xv6 $(DISTRIB_COREUTILS) $(DISTRIB_ULIBC_TESTS)
	$(LOG_CMD) ./mkfs.xv6 distrib_check.img test
	@echo "\033[32;1mCreated test distribution disk image "\""$@"\""\033[0m"

mkfs.xv6: mkfs/mkfs.xv6.c
	$(LOG_CC) $(CC) -Wall -ggdb -O0 -I$(shell pwd)/../include -o mkfs.xv6 mkfs/mkfs.xv6.c

coreutils/%: coreutils/%.o $(DISTRIB_ULIBC)
	$(LOG_LD) $(LD) $(LDFLAGS) -N -e main -Ttext 0 -o $@ $^

coreutils/%.o: coreutils/%.c
	$(LOG_CC) $(CC) $(CFLAGS) -c -o $@ coreutils/$*.c

ulibc/%.o: ulibc/%.c
	$(LOG_CC) $(CC) $(CFLAGS) -c -o $@ ulibc/$*.c

ulibc/%.o: ulibc/%.S
	$(LOG_CC) $(CC) $(ASFLAGS) -c -o $@ ulibc/$*.S

$(DISTRIB_ULIBC): $(DISTRIB_ULIBC_OBJECTS)
	$(LOG_LD) $(LD) $(LDFLAGS) -r $(DISTRIB_ULIBC_OBJECTS) -o $(DISTRIB_ULIBC)

tests/%: tests/%.o $(DISTRIB_ULIBC)
	$(LOG_LD) $(LD) $(LDFLAGS) -N -e main -Ttext 0 -o $@ $^

tests/%.o: tests/%.c
	$(LOG_CC) $(CC) $(CFLAGS) -c -o $@ tests/$*.c

clean:
	$(LOG_CMD) $(RM) -rf distrib.img
	$(LOG_CMD) $(RM) -rf distrib_check.img
	$(LOG_CMD) $(RM) -rf mkfs.xv6
	$(LOG_CMD) $(RM) -rf $(DISTRIB_COREUTILS)
	$(LOG_CMD) $(RM) -rf coreutils/*.o
	$(LOG_CMD) $(RM) -rf ulibc/*.o
	$(LOG_CMD) $(RM) -rf ulibc/*/*.o
	$(LOG_CMD) $(RM) -rf tests/*.o
